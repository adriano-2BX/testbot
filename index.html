<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>AuditIA Manager</title>

  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

  <script src="https://cdn.tailwindcss.com"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', sans-serif;
      overscroll-behavior-y: contain;
      background-color: #f8fafc; /* bg-slate-50 */
    }
    .content-scrollable::-webkit-scrollbar {
      display: none;
    }
    .content-scrollable {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    .spinner {
        border: 2px solid rgba(255,255,255,0.3);
        border-radius: 50%;
        border-top-color: #fff;
        width: 16px;
        height: 16px;
        animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .toast-enter {
      opacity: 0;
      transform: translateY(20px);
    }
    .toast-enter-active {
      opacity: 1;
      transform: translateY(0);
      transition: opacity 300ms, transform 300ms;
    }
    .toast-exit {
      opacity: 1;
      transform: translateY(0);
    }
    .toast-exit-active {
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 300ms, transform 300ms;
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen antialiased">

<div id="root"></div>

<script type="text/babel">
  // Bloco de verificação de dependências
  if (!window.React || !window.ReactDOM) {
    document.getElementById('root').innerHTML = `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg max-w-md mx-auto mt-10" role="alert"><h2 class="font-bold">Erro Crítico</h2><p>As bibliotecas React ou ReactDOM não foram carregadas. A aplicação não pode ser iniciada.</p></div>`;
    throw new Error('React ou ReactDOM não foram carregados.');
  }

  // --- DADOS PARA AUTENTICAÇÃO LOCAL ---
  const authUsers = [
    { id: 1, name: "Admin User", role: "admin", email: "adriano@2bx.com.br", password: "123" },
    { id: 2, name: "Alessandra Silva", role: "tester", email: "alessandra@2bx.com.br", password: "123" },
    { id: 3, name: "Client User", role: "client", email: "client@2bx.com.br", password: "123" },
  ];

  // --- DADOS PREDEFINIDOS DE TESTE (Modelos Locais do Frontend) ---
  const presetTests = [
    { 
        id: 'GREETING', name: "Saudação e Despedida", category: "Funcional",
        description: "Verifica se o bot saúda, se apresenta e se despede corretamente.", 
        formFields: [ 
            { name: 'didGreet', label: 'Bot iniciou com uma saudação apropriada?', type: 'tri-state' }, 
            { name: 'offeredHelp', label: 'Ofereceu ajuda ou apresentou-se claramente?', type: 'tri-state' }, 
            { name: 'didFarewell', label: 'Despediu-se cordialmente no final?', type: 'tri-state' },
            { name: 'notes', label: 'Observações', type: 'textarea' } 
        ]
    },
    {
        id: 'CONTEXT_MANAGEMENT', name: "Gestão de Contexto", category: "Funcional",
        description: "Avalia a capacidade do bot de manter o contexto em múltiplos turnos de conversa.",
        formFields: [
            { name: 'initialQuery', label: 'Pergunta Inicial', type: 'textarea' },
            { name: 'followUpQuery', label: 'Pergunta de Continuação', type: 'textarea' },
            { name: 'contextKept', label: 'O bot manteve o contexto?', type: 'tri-state' },
            { name: 'notes', label: 'Observações de Contexto', type: 'textarea' }
        ]
    },
    {
        id: 'HUMAN_HANDOFF', name: "Transbordo para Atendente Humano", category: "UX",
        description: "Testa o processo de transferência da conversa para um atendente humano.",
        formFields: [
            { name: 'trigger', label: 'Gatilho para Transbordo', type: 'textarea', placeholder: 'ex: "falar com atendente"' },
            { name: 'wasHandoffSmooth', label: 'O transbordo foi executado sem problemas?', type: 'tri-state' },
            { name: 'contextTransferred', label: 'O histórico foi transferido para o atendente?', type: 'tri-state' },
            { name: 'notes', label: 'Observações sobre o Transbordo', type: 'textarea' }
        ]
    },
  ];

  const webhookEvents = [
      { id: 'client_created', label: 'Cliente Criado' },
      { id: 'project_created', label: 'Projeto Criado' },
      { id: 'user_created', label: 'Usuário Criado' },
      { id: 'test_created', label: 'Teste Criado' },
      { id: 'test_completed', label: 'Teste Concluído' }
  ];

  const initialDataState = {
    clients: [], projects: [], users: [], testCases: [], reports: [], customTestTemplates: [], webhooks: []
  };

  // --- API HELPER ---
  const API_BASE_URL = 'https://apiauditia.2bx.com.br';

  async function apiCall(endpoint, method = 'GET', body = null) {
      const config = {
          method,
          headers: { 
              'Content-Type': 'application/json',
              'Accept': 'application/json'
          },
      };
      if (body) {
          config.body = JSON.stringify(body);
      }
      
      const response = await fetch(`${API_BASE_URL}${endpoint}`, config);

      const responseText = await response.text();

      if (response.status === 204 || !responseText) {
          if (response.ok) return { success: true };
          else throw new Error(`Erro da API: ${response.status} - Resposta vazia.`);
      }

      let cleanJsonString = responseText;
      const jsonStartIndex = responseText.search(/\[|{/);

      if (jsonStartIndex === -1) {
          console.error("A resposta da API não contém um JSON válido. Resposta recebida:", responseText);
          throw new Error(`O servidor retornou uma resposta inesperada (não-JSON).`);
      }

      if (jsonStartIndex > 0) {
          cleanJsonString = responseText.substring(jsonStartIndex);
      }
      
      let jsonData;
      try {
          jsonData = JSON.parse(cleanJsonString);
      } catch (e) {
          console.error("A resposta da API não é um JSON válido mesmo após a limpeza. Resposta Original:", responseText);
          throw new Error(`O servidor retornou uma resposta inesperada (não-JSON). Verifique o console do navegador para detalhes.`);
      }

      if (!response.ok) {
          throw new Error(jsonData.message || jsonData.error || `Erro da API: ${response.status}`);
      }

      return jsonData;
  }

  // --- ÍCONES (SVG como Componentes React) ---
  const HomeIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>);
  const ClipboardListIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg>);
  const UsersIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>);
  const FileTextIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>);
  const LogOutIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>);
  const ArrowLeftIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>);
  const BuildingIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="16" height="20" x="4" y="2" rx="2" ry="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M12 6h.01"/><path d="M12 10h.01"/><path d="M12 14h.01"/><path d="M16 10h.01"/><path d="M16 14h.01"/><path d="M8 10h.01"/><path d="M8 14h.01"/></svg>);
  const FolderIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.23A2 2 0 0 0 8.07 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/></svg>);
  const PlusIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>);
  const HelpCircleIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>);
  const BeakerIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4.5 3h15"/><path d="M6 3v16a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V3"/><path d="M6 14h12"/></svg>);
  const EditIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>);
  const TrashIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>);
  const SettingsIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>);
  const RssIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/></svg>);


  // --- CONTEXTOS ---
  const AuthContext = React.createContext(null);
  const DataContext = React.createContext(null);
  const NavigationContext = React.createContext(null);

  function AuthProvider({ children }) {
    const [user, setUser] = React.useState(null);

    const login = (email, password) => {
        const foundUser = authUsers.find(u => u.email === email && u.password === password);
        if (foundUser) {
            const { password, ...userToStore } = foundUser;
            setUser(userToStore);
            localStorage.setItem('auditia-user', JSON.stringify(userToStore));
            return true;
        }
        return false;
    };

    const logout = () => {
        setUser(null);
        localStorage.removeItem('auditia-user');
    };

    React.useEffect(() => {
        try {
            const loggedInUser = localStorage.getItem('auditia-user');
            if (loggedInUser) {
                setUser(JSON.parse(loggedInUser));
            }
        } catch (e) {
            console.error("Failed to parse user from localStorage", e);
            localStorage.removeItem('auditia-user');
        }
    }, []);

    return <AuthContext.Provider value={{ user, login, logout }}>{children}</AuthContext.Provider>;
  }

  function DataProvider({ children }) {
      const [data, setData] = React.useState(initialDataState);
      const [loading, setLoading] = React.useState(true);
      const [error, setError] = React.useState(null);

      const fetchData = React.useCallback(async () => {
          setLoading(true);
          setError(null);
          try {
              const [clients, projects, users, testCases, reports, customTestTemplates, webhooks] = await Promise.all([
                  apiCall('/clients'),
                  apiCall('/projects'),
                  apiCall('/users'),
                  apiCall('/test-cases'),
                  apiCall('/reports'),
                  apiCall('/custom-templates'),
                  apiCall('/webhooks')
              ]);
              setData({ 
                  clients: Array.isArray(clients) ? clients : [],
                  projects: Array.isArray(projects) ? projects : [],
                  users: Array.isArray(users) ? users : [],
                  testCases: Array.isArray(testCases) ? testCases : [],
                  reports: Array.isArray(reports) ? reports : [],
                  customTestTemplates: Array.isArray(customTestTemplates) ? customTestTemplates : [],
                  webhooks: Array.isArray(webhooks) ? webhooks : [] 
              });
          } catch (e) {
              setError(e.message || "Falha ao carregar os dados da API. Verifique a conexão e tente novamente.");
              console.error(e);
          } finally {
              setLoading(false);
          }
      }, []);

      React.useEffect(() => {
          fetchData();
      }, [fetchData]);

      const reloadData = async (dataType) => {
        const endpointMap = {
            clients: 'clients',
            projects: 'projects',
            users: 'users',
            testCases: 'test-cases',
            reports: 'reports',
            customTestTemplates: 'custom-templates',
            webhooks: 'webhooks'
        };
        const endpoint = endpointMap[dataType];
        if (!endpoint) {
            console.error(`Tipo de dados desconhecido para recarregar: ${dataType}`);
            return;
        }

        try {
            const updatedData = await apiCall(`/${endpoint}`);
            setData(prev => ({ ...prev, [dataType]: Array.isArray(updatedData) ? updatedData : [] }));
        } catch (e) {
            console.error(`Falha ao recarregar ${dataType}:`, e);
            setError(`Não foi possível atualizar os dados de ${dataType}.`);
        }
      };

      const addClient = async (newClient) => { await apiCall('/clients', 'POST', newClient); await reloadData('clients'); };
      const updateClient = async (clientId, updates) => { await apiCall(`/clients/${clientId}`, 'PUT', updates); await reloadData('clients'); };
      const deleteClient = async (clientId) => { await apiCall(`/clients/${clientId}`, 'DELETE'); await reloadData('clients'); await reloadData('projects'); };

      const addProject = async (newProject) => { await apiCall('/projects', 'POST', newProject); await reloadData('projects'); };
      const updateProject = async (projectId, updates) => { await apiCall(`/projects/${projectId}`, 'PUT', updates); await reloadData('projects'); };
      const deleteProject = async (projectId) => { await apiCall(`/projects/${projectId}`, 'DELETE'); await reloadData('projects'); await reloadData('testCases');};
      
      const addUser = async (newUser) => { await apiCall('/users', 'POST', newUser); await reloadData('users'); };
      const updateUser = async (userId, updates) => { await apiCall(`/users/${userId}`, 'PUT', updates); await reloadData('users'); };
      const deleteUser = async (userId) => { await apiCall(`/users/${userId}`, 'DELETE'); await reloadData('users'); };

      const addTest = async (newTest) => { await apiCall('/test-cases', 'POST', newTest); await reloadData('testCases'); };
      const updateTestCase = async (testCaseId, updates) => { await apiCall(`/test-cases/${testCaseId}`, 'PUT', updates); await reloadData('testCases'); };
      const deleteTest = async (testCaseId) => { await apiCall(`/test-cases/${testCaseId}`, 'DELETE'); await reloadData('testCases'); };
      
      const executeTest = async (testCaseId, results, user) => {
          const payload = { userId: user.id, results };
          await apiCall(`/test-cases/${testCaseId}/execute`, 'POST', payload);
          await reloadData('testCases');
          await reloadData('reports');
      };
      
      const addCustomTestTemplate = async (newTemplate) => { await apiCall('/custom-templates', 'POST', newTemplate); await reloadData('customTestTemplates'); };
      const updateCustomTestTemplate = async (templateId, updates) => { await apiCall(`/custom-templates/${templateId}`, 'PUT', updates); await reloadData('customTestTemplates'); };
      const deleteCustomTestTemplate = async (templateId) => { await apiCall(`/custom-templates/${templateId}`, 'DELETE'); await reloadData('customTestTemplates'); };

      const addWebhook = async (newWebhook) => { await apiCall('/webhooks', 'POST', newWebhook); await reloadData('webhooks'); };
      const updateWebhook = async (webhookId, updates) => { await apiCall(`/webhooks/${webhookId}`, 'PUT', updates); await reloadData('webhooks'); };
      const deleteWebhook = async (webhookId) => { await apiCall(`/webhooks/${webhookId}`, 'DELETE'); await reloadData('webhooks'); };
      
      const value = { data, loading, error, fetchData, addClient, updateClient, deleteClient, addProject, updateProject, deleteProject, addUser, updateUser, deleteUser, addTest, updateTestCase, deleteTest, executeTest, addCustomTestTemplate, updateCustomTestTemplate, deleteCustomTestTemplate, addWebhook, updateWebhook, deleteWebhook };

      return <DataContext.Provider value={value}>{children}</DataContext.Provider>;
  }

  function NavigationProvider({ children }) {
    const [history, setHistory] = React.useState(['dashboard']);
    const page = history[history.length - 1];
    const navigate = (newPage) => setHistory(prev => [...prev, newPage]);
    const goBack = () => setHistory(prev => prev.length > 1 ? prev.slice(0, -1) : prev);
    const reset = (page) => setHistory([page || 'dashboard']);
    return <NavigationContext.Provider value={{ page, history, navigate, goBack, reset }}>{children}</NavigationContext.Provider>;
  }
  
  const useAuth = () => React.useContext(AuthContext);
  const useData = () => React.useContext(DataContext);
  const useNavigation = () => React.useContext(NavigationContext);

  // --- Componentes ---
  function Login() {
    const { login } = useAuth();
    const [email, setEmail] = React.useState("");
    const [password, setPassword] = React.useState("");
    const [error, setError] = React.useState("");
    const [isLoading, setIsLoading] = React.useState(false);

    const handleLogin = (e) => {
      e.preventDefault();
      if (!email || !password) { setError("Preencha todos os campos."); return; }
      setIsLoading(true);
      setError("");
      setTimeout(() => {
        const success = login(email, password);
        if (!success) { setError("Credenciais inválidas."); }
        setIsLoading(false);
      }, 500);
    };

    return (
      <div className="min-h-screen flex items-center justify-center bg-slate-50 px-4">
        <div className="bg-white p-8 rounded-2xl shadow-lg w-full max-w-sm">
          <h1 className="text-3xl font-bold text-slate-800 text-center mb-2">
            audit<span className="text-sky-500">IA</span>
          </h1>
          <p className="text-center text-slate-500 mb-8">Sistema de Auditoria em Chatbots</p>
          <form onSubmit={handleLogin}>
            <div className="mb-4">
                <label className="text-sm font-bold text-slate-600 mb-1 block" htmlFor="email">Email</label>
                <input id="email" type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full p-3 bg-slate-100 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 transition"/>
            </div>
            <div className="mb-6">
                <label className="text-sm font-bold text-slate-600 mb-1 block" htmlFor="password">Senha</label>
                <input id="password" type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full p-3 bg-slate-100 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 transition"/>
            </div>
            {error && <p className="text-red-500 text-sm text-center mb-4">{error}</p>}
            <button type="submit" disabled={isLoading} className="w-full bg-sky-500 text-white p-3 rounded-lg hover:bg-sky-600 transition duration-200 font-bold disabled:bg-sky-300 flex items-center justify-center">
              {isLoading ? <div className="w-6 h-6 border-2 border-white border-t-transparent rounded-full animate-spin"></div> : 'Entrar'}
            </button>
          </form>
        </div>
      </div>
    );
  }

  function AppLayout({ children }) {
    const { user, logout } = useAuth();
    const { page, goBack } = useNavigation();
    const { loading, error, fetchData } = useData();
    
    const pageTitles = {
      dashboard: "Dashboard", 'test-management': "Gerenciar Testes", 'user-management': "Gerenciar Usuários",
      reports: "Relatórios", 'client-management': "Gerenciar Clientes", 'project-management': "Gerenciar Projetos",
      'test-guidelines': "Orientações de Teste", 'custom-templates': "Modelos de Teste", 'settings': "Configurações"
    };
    const mainPages = Object.keys(pageTitles);
    const isSubPage = !mainPages.includes(page);

    return (
        <div className="h-screen w-screen flex flex-col sm:flex-row bg-slate-50">
            <DesktopSidebar user={user} logout={logout} />
            <div className="flex-1 flex flex-col overflow-hidden">
                <header className="bg-white/80 backdrop-blur-lg border-b border-slate-200 w-full z-10">
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div className="flex items-center justify-between h-16">
                            {isSubPage ? ( <button onClick={goBack} className="flex items-center gap-2 text-slate-600 hover:text-sky-600"><ArrowLeftIcon className="w-6 h-6" /><span className="font-semibold hidden sm:block">Voltar</span></button>) : <div className="sm:hidden w-10"></div>}
                            <h1 className="text-lg font-bold text-slate-800">{pageTitles[page] || "Detalhes"}</h1>
                             <div className="w-10 sm:hidden"></div>
                             <button onClick={logout} className="hidden sm:flex items-center gap-2 text-sm font-semibold text-slate-500 hover:text-red-500"><LogOutIcon className="w-5 h-5" />Sair</button>
                        </div>
                    </div>
                </header>
                <main className="flex-1 overflow-y-auto content-scrollable p-4 sm:p-6 pb-24 sm:pb-6">
                  {loading ? (
                    <div className="flex justify-center items-center h-full">
                      <div className="w-16 h-16 border-4 border-sky-500 border-t-transparent rounded-full animate-spin"></div>
                    </div>
                  ) : error ? (
                    <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg" role="alert">
                      <p className="font-bold">Erro de Conexão</p>
                      <p>{error}</p>
                      <button onClick={fetchData} className="mt-2 px-3 py-1 bg-red-500 text-white rounded-md text-sm font-semibold">Tentar Novamente</button>
                    </div>
                  ) : (
                    children
                  )}
                </main>
                <BottomNav user={user} logout={logout} />
            </div>
        </div>
    );
  }
  
  function DesktopSidebar({ user, logout }) {
      const { page, reset } = useNavigation();
      const navItems = {
        admin: [
          { name: "Dashboard", path: "dashboard", icon: HomeIcon }, { name: "Clientes", path: "client-management", icon: BuildingIcon },
          { name: "Projetos", path: "project-management", icon: FolderIcon }, { name: "Testes", path: "test-management", icon: ClipboardListIcon },
          { name: "Usuários", path: "user-management", icon: UsersIcon }, { name: "Relatórios", path: "reports", icon: FileTextIcon },
          { name: "Modelos", path: "custom-templates", icon: BeakerIcon }, { name: "Orientações", path: "test-guidelines", icon: HelpCircleIcon },
          { name: "Configurações", path: "settings", icon: SettingsIcon },
        ],
        tester: [ { name: "Dashboard", path: "dashboard", icon: HomeIcon }, { name: "Meus Testes", path: "test-management", icon: ClipboardListIcon }, { name: "Relatórios", path: "reports", icon: FileTextIcon }, { name: "Orientações", path: "test-guidelines", icon: HelpCircleIcon } ],
        client: [ { name: "Dashboard", path: "dashboard", icon: HomeIcon }, { name: "Relatórios", path: "reports", icon: FileTextIcon }, { name: "Orientações", path: "test-guidelines", icon: HelpCircleIcon } ],
      };
      return (
          <div className="hidden sm:flex flex-col w-64 bg-white border-r border-slate-200 p-4">
              <h1 className="text-2xl font-bold text-slate-800 mb-10 px-2">audit<span className="text-sky-500">IA</span></h1>
              <nav className="flex-1 space-y-2">
                  {(navItems[user.role] || []).map(item => {
                      const Icon = item.icon;
                      const isActive = page === item.path;
                      return ( <button key={item.path} onClick={() => reset(item.path)} className={`w-full flex items-center gap-3 text-left py-2.5 px-4 rounded-lg transition-colors text-base font-semibold ${isActive ? 'bg-sky-500 text-white shadow-sm' : 'text-slate-600 hover:bg-slate-100'}`}><Icon className="w-5 h-5" />{item.name}</button> );
                  })}
              </nav>
              <div className="pt-6 border-t border-slate-200"><p className="text-sm font-semibold text-slate-800">{user.name}</p><p className="text-xs text-slate-500 capitalize">{user.role}</p></div>
          </div>
      );
  }
  
  function BottomNav({user, logout}) {
      const { page, reset } = useNavigation();
      const navItems = {
        admin: [ { name: "Dashboard", path: "dashboard", icon: HomeIcon }, { name: "Testes", path: "test-management", icon: ClipboardListIcon }, { name: "Relatórios", path: "reports", icon: FileTextIcon }, { name: "Config.", path: "settings", icon: SettingsIcon } ],
        tester: [ { name: "Dashboard", path: "dashboard", icon: HomeIcon }, { name: "Meus Testes", path: "test-management", icon: ClipboardListIcon }, { name: "Relatórios", path: "reports", icon: FileTextIcon }, { name: "Orientações", path: "test-guidelines", icon: HelpCircleIcon } ],
        client: [ { name: "Dashboard", path: "dashboard", icon: HomeIcon }, { name: "Relatórios", path: "reports", icon: FileTextIcon }, { name: "Orientações", path: "test-guidelines", icon: HelpCircleIcon } ],
      };
    return(
      <nav className="sm:hidden fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-lg border-t border-slate-200 z-20">
          <div className="flex justify-around items-center h-16">
            {(navItems[user.role] || []).map(item => {
              const Icon = item.icon;
              const isActive = page === item.path;
              return ( <button key={item.path} onClick={() => reset(item.path)} className={`flex flex-col items-center justify-center w-full h-full transition-colors ${isActive ? 'text-sky-500' : 'text-slate-500 hover:text-sky-500'}`}><Icon className="w-6 h-6 mb-1"/><span className="text-xs font-medium">{item.name}</span></button>);
            })}
            <button onClick={logout} className="flex flex-col items-center justify-center w-full h-full text-slate-500 hover:text-red-500"><LogOutIcon className="w-6 h-6 mb-1"/><span className="text-xs font-medium">Sair</span></button>
          </div>
        </nav>
    );
  }
  
  function Modal({ isOpen, onClose, title, children, size = 'lg' }) {
    if (!isOpen) return null;
    const sizeClasses = { sm: 'max-w-sm', md: 'max-w-md', lg: 'max-w-lg', xl: 'max-w-xl', '2xl': 'max-w-2xl' };
    return (
      <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4" onClick={onClose}>
        <div className={`bg-white rounded-2xl shadow-xl w-full ${sizeClasses[size]}`} onClick={(e) => e.stopPropagation()}>
          <div className="p-6 border-b border-slate-200 flex justify-between items-center">
            <h3 className="text-lg font-bold text-slate-800">{title}</h3>
            <button onClick={onClose} className="text-slate-400 hover:text-slate-600 text-2xl leading-none">&times;</button>
          </div>
          <div className="p-6 max-h-[70vh] overflow-y-auto content-scrollable">{children}</div>
        </div>
      </div>
    );
  }

  function ConfirmationModal({ isOpen, onClose, onConfirm, title, message, loading }) {
    if (!isOpen) return null;
    return (
      <Modal isOpen={isOpen} onClose={onClose} title={title} size="sm">
        <div className="space-y-4">
          <p className="text-slate-600">{message}</p>
          <div className="flex justify-end gap-3 pt-4">
            <button onClick={onClose} disabled={loading} className="px-4 py-2 rounded-lg bg-slate-200 text-slate-800 font-semibold hover:bg-slate-300 transition disabled:opacity-50">Cancelar</button>
            <button onClick={onConfirm} disabled={loading} className="px-4 py-2 rounded-lg bg-red-500 text-white font-semibold hover:bg-red-600 transition disabled:bg-red-300 flex items-center justify-center gap-2">
              {loading && <div className="spinner"></div>}
              <span>Confirmar</span>
            </button>
          </div>
        </div>
      </Modal>
    );
  }

  function Toast({ message, type, onDismiss }) {
    React.useEffect(() => {
      if (message) {
        const timer = setTimeout(onDismiss, 3000);
        return () => clearTimeout(timer);
      }
    }, [message, onDismiss]);
    if (!message) return null;
    const styles = { success: "bg-green-500", error: "bg-red-500" };
    return (<div className={`fixed bottom-24 sm:bottom-10 left-1/2 -translate-x-1/2 ${styles[type]} text-white px-6 py-3 rounded-full shadow-lg text-sm font-semibold toast-enter-active`}>{message}</div>);
  }

  // --- Páginas e Componentes de Gestão ---

  function Dashboard() { 
      const { user } = useAuth();
      const { data } = useData();
      if (!data) return null;

      const assignedTests = (data.testCases || []).filter(tc => tc.assignedTo === user.id);
      const completedTests = (data.reports || []).filter(r => r.testerId === user.id).length;
      const pendingTests = assignedTests.filter(tc => tc.status === 'pending').length;
      return (
        <div className="space-y-6">
          <h2 className="text-2xl font-bold text-slate-800">Olá, {user.name.split(' ')[0]}!</h2>
          {user.role === 'tester' ? (
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
              <StatCard title="Total de Testes Atribuídos" value={assignedTests.length} color="indigo" />
              <StatCard title="Testes Realizados" value={completedTests} color="green" />
              <StatCard title="Testes Pendentes" value={pendingTests} color="sky" />
            </div>
          ) : (
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
              <StatCard title="Total de Relatórios Gerados" value={(data.reports || []).length} color="sky" />
              <StatCard title="Projetos Ativos" value={(data.projects || []).length} color="blue" />
              <StatCard title="Clientes na Base" value={(data.clients || []).length} color="indigo" />
            </div>
          )}
        </div>
      );
  }
  function StatCard({ title, value, color }) {
    const colors = { blue: 'from-blue-500 to-blue-400', sky: 'from-sky-500 to-sky-400', indigo: 'from-indigo-500 to-indigo-400', green: 'from-green-500 to-green-400', red: 'from-red-500 to-red-400' };
    return (<div className="bg-white p-5 rounded-xl shadow-sm"><h3 className="text-sm font-semibold text-slate-600">{title}</h3><p className={`text-3xl font-bold mt-2 bg-clip-text text-transparent bg-gradient-to-r ${colors[color]}`}>{value}</p></div>);
  }

  function ClientManagement() {
      const { data, deleteClient } = useData();
      const [isAddModalOpen, setAddModalOpen] = React.useState(false);
      const [isEditModalOpen, setEditModalOpen] = React.useState(false);
      const [isDeleteModalOpen, setDeleteModalOpen] = React.useState(false);
      const [selectedClient, setSelectedClient] = React.useState(null);
      const [loading, setLoading] = React.useState(false);

      const handleEdit = (client) => {
          setSelectedClient(client);
          setEditModalOpen(true);
      };

      const handleDelete = (client) => {
          setSelectedClient(client);
          setDeleteModalOpen(true);
      };

      const confirmDelete = async () => {
          if (!selectedClient) return;
          setLoading(true);
          try {
            await deleteClient(selectedClient.id);
            setDeleteModalOpen(false);
            setSelectedClient(null);
          } catch(e) {
            console.error(e);
            alert(e.message || "Erro ao excluir cliente.");
          } finally {
            setLoading(false);
          }
      };

      return (
        <div className="space-y-6">
          <button onClick={() => setAddModalOpen(true)} className="w-full sm:w-auto flex items-center justify-center gap-2 bg-sky-500 text-white px-4 py-3 rounded-lg font-semibold shadow hover:bg-sky-600 transition">
            <PlusIcon className="w-5 h-5" /> Adicionar Cliente
          </button>
          <div className="bg-white rounded-xl shadow-sm p-4 sm:p-6">
            <h3 className="font-bold text-lg mb-4">Clientes</h3>
            <div className="space-y-3">
              {(data.clients || []).length === 0 && <p className="text-center text-slate-500 py-4">Nenhum cliente encontrado.</p>}
              {(data.clients || []).map(c => (
                <div key={c.id} className="bg-slate-50 p-3 rounded-lg flex justify-between items-center">
                  <span className="font-semibold">{c.name}</span>
                  <div className="flex gap-2">
                      <button onClick={() => handleEdit(c)} className="p-1 text-slate-500 hover:text-blue-600 transition-colors"><EditIcon className="w-5 h-5" /></button>
                      <button onClick={() => handleDelete(c)} className="p-1 text-slate-500 hover:text-red-600 transition-colors"><TrashIcon className="w-5 h-5" /></button>
                  </div>
                </div>
              ))}
            </div>
          </div>
          <AddClientModal isOpen={isAddModalOpen} onClose={() => setAddModalOpen(false)} />
          <EditClientModal isOpen={isEditModalOpen} onClose={() => { setEditModalOpen(false); setSelectedClient(null); }} client={selectedClient} />
          <ConfirmationModal
            isOpen={isDeleteModalOpen}
            onClose={() => setDeleteModalOpen(false)}
            onConfirm={confirmDelete}
            title="Confirmar Exclusão"
            message={`Tem a certeza que deseja excluir o cliente "${selectedClient?.name}"? Todos os projetos associados também serão excluídos.`}
            loading={loading}
          />
        </div>
      );
  }
  
  function AddClientModal({ isOpen, onClose }) {
    const { addClient } = useData();
    const [name, setName] = React.useState('');
    const [error, setError] = React.useState('');
    const [loading, setLoading] = React.useState(false);

    const handleSave = async () => {
      if (!name.trim()) { setError('O nome do cliente é obrigatório.'); return; }
      setLoading(true);
      setError('');
      try {
        await addClient({ name });
        setName('');
        onClose();
      } catch (e) {
        setError(e.message || "Erro ao salvar cliente.");
      } finally {
        setLoading(false);
      }
    };
    return (
      <Modal isOpen={isOpen} onClose={onClose} title="Adicionar Novo Cliente">
        <div className="space-y-4">
          {error && <p className="text-red-500 text-sm">{error}</p>}
          <input type="text" placeholder="Nome do Cliente" value={name} onChange={(e) => setName(e.target.value)} className="w-full p-3 bg-slate-100 border border-slate-300 rounded-lg" />
          <button onClick={handleSave} disabled={loading} className="w-full bg-sky-500 text-white p-3 rounded-lg hover:bg-sky-600 transition font-bold disabled:bg-sky-300 flex items-center justify-center gap-2">
            {loading && <div className="spinner"></div>}
            Salvar Cliente
          </button>
        </div>
      </Modal>
    );
  }
  
  function EditClientModal({ isOpen, onClose, client }) {
    const { updateClient } = useData();
    const [name, setName] = React.useState('');
    const [error, setError] = React.useState('');
    const [loading, setLoading] = React.useState(false);

    React.useEffect(() => {
      if (client) { setName(client.name); }
    }, [client]);

    const handleSave = async () => {
      if (!name.trim()) { setError('O nome do cliente é obrigatório.'); return; }
      setLoading(true);
      setError('');
      try {
        await updateClient(client.id, { name });
        onClose();
      } catch (e) {
        setError(e.message || "Erro ao atualizar cliente.");
      } finally {
        setLoading(false);
      }
    };

    if (!client) return null;

    return (
      <Modal isOpen={isOpen} onClose={onClose} title={`Editar Cliente: ${client.name}`}>
        <div className="space-y-4">
          {error && <p className="text-red-500 text-sm">{error}</p>}
          <input type="text" placeholder="Nome do Cliente" value={name} onChange={(e) => setName(e.target.value)} className="w-full p-3 bg-slate-100 border border-slate-300 rounded-lg" />
          <button onClick={handleSave} disabled={loading} className="w-full bg-sky-500 text-white p-3 rounded-lg hover:bg-sky-600 transition font-bold disabled:bg-sky-300 flex items-center justify-center gap-2">
            {loading && <div className="spinner"></div>}
            Salvar Alterações
          </button>
        </div>
      </Modal>
    );
  }

  function ProjectManagement() { 
      const { data, deleteProject } = useData();
      const [isAddModalOpen, setAddModalOpen] = React.useState(false);
      const [isEditModalOpen, setEditModalOpen] = React.useState(false);
      const [isDeleteModalOpen, setDeleteModalOpen] = React.useState(false);
      const [selectedProject, setSelectedProject] = React.useState(null);
      const [loading, setLoading] = React.useState(false);
  
      const handleEdit = (project) => {
          setSelectedProject(project);
          setEditModalOpen(true);
      };
  
      const handleDelete = (project) => {
          setSelectedProject(project);
          setDeleteModalOpen(true);
      };
  
      const confirmDelete = async () => {
          if (!selectedProject) return;
          setLoading(true);
          try {
              await deleteProject(selectedProject.id);
              setDeleteModalOpen(false);
              setSelectedProject(null);
          } catch (e) {
              alert(e.message || "Erro ao excluir projeto.");
          } finally {
              setLoading(false);
          }
      };
  
      return (
          <div className="space-y-6">
              <button onClick={() => setAddModalOpen(true)} className="w-full sm:w-auto flex items-center justify-center gap-2 bg-sky-500 text-white px-4 py-3 rounded-lg font-semibold shadow hover:bg-sky-600 transition">
                  <PlusIcon className="w-5 h-5" /> Adicionar Projeto
              </button>
              <div className="bg-white rounded-xl shadow-sm p-4 sm:p-6">
                  <h3 className="font-bold text-lg mb-4">Projetos</h3>
                  <div className="space-y-3">
                      {(data.projects || []).length === 0 && <p className="text-center text-slate-500 py-4">Nenhum projeto encontrado.</p>}
                      {(data.projects || []).map(p => {
                          const client = (data.clients || []).find(c => c.id == p.clientId);
                          return (
                              <div key={p.id} className="bg-slate-50 p-4 rounded-lg">
                                  <div className="flex justify-between items-start">
                                      <div>
                                          <p className="font-bold">{p.name}</p>
                                          <p className="text-sm text-sky-600 font-semibold">{p.whatsappNumber}</p>
                                          <p className="text-sm text-slate-500 mt-1">{client?.name || 'Cliente não encontrado'}</p>
                                      </div>
                                      <div className="flex gap-1 flex-shrink-0">
                                          <button onClick={() => handleEdit(p)} className="p-1 text-slate-500 hover:text-blue-600 transition-colors"><EditIcon className="w-5 h-5" /></button>
                                          <button onClick={() => handleDelete(p)} className="p-1 text-slate-500 hover:text-red-600 transition-colors"><TrashIcon className="w-5 h-5" /></button>
                                      </div>
                                  </div>
                                  <p className="text-sm text-slate-700 mt-2">{p.description}</p>
                              </div>
                          );
                      })}
                  </div>
              </div>
              <AddProjectModal isOpen={isAddModalOpen} onClose={() => setAddModalOpen(false)} />
              <EditProjectModal isOpen={isEditModalOpen} onClose={() => { setEditModalOpen(false); setSelectedProject(null); }} project={selectedProject} />
              <ConfirmationModal
                  isOpen={isDeleteModalOpen}
                  onClose={() => setDeleteModalOpen(false)}
                  onConfirm={confirmDelete}
                  title="Confirmar Exclusão"
                  message={`Tem a certeza que deseja excluir o projeto "${selectedProject?.name}"?`}
                  loading={loading}
              />
          </div>
      )
  }
  
  function AddProjectModal({ isOpen, onClose }) {
      const { data, addProject } = useData();
      const [newProject, setNewProject] = React.useState({ name: '', clientId: '', whatsappNumber: '', description: '', objective: '' });
      const [error, setError] = React.useState('');
      const [loading, setLoading] = React.useState(false);
      
      const handleSave = async () => {
          if (!newProject.name.trim() || !newProject.clientId || !newProject.whatsappNumber.trim()) { setError('Nome, Cliente e Nº de WhatsApp são obrigatórios.'); return; }
          setLoading(true);
          setError('');
          try {
            await addProject(newProject);
            setNewProject({ name: '', clientId: '', whatsappNumber: '', description: '', objective: '' });
            onClose();
          } catch(e) {
            setError(e.message || "Erro ao salvar projeto.");
          } finally {
            setLoading(false);
          }
      };
      const handleInputChange = (e) => {
          const { name, value } = e.target;
          setNewProject(prev => ({ ...prev, [name]: value }));
      };
      return (
          <Modal isOpen={isOpen} onClose={onClose} title="Adicionar Novo Projeto">
              <div className="space-y-4">
                  {error && <p className="text-red-500 text-sm">{error}</p>}
                  <input type="text" name="name" placeholder="Nome do Projeto" value={newProject.name} onChange={handleInputChange} className="w-full p-3 bg-slate-100 border border-slate-300 rounded-lg" />
                  <input type="text" name="whatsappNumber" placeholder="Nº de WhatsApp do Bot" value={newProject.whatsappNumber} onChange={handleInputChange} className="w-full p-3 bg-slate-100 border border-slate-300 rounded-lg" />
                  <textarea name="description" placeholder="Descrição do Projeto" value={newProject.description} onChange={handleInputChange} className="w-full p-3 bg-slate-100 border border-slate-300 rounded-lg min-h-[80px]"></textarea>
                  <textarea name="objective" placeholder="Objetivo Principal" value={newProject.objective} onChange={handleInputChange} className="w-full p-3 bg-slate-100 border border-slate-300 rounded-lg min-h-[80px]"></textarea>
                  <select name="clientId" onChange={handleInputChange} value={newProject.clientId} className="w-full p-3 bg-slate-100 border border-slate-300 rounded-lg">
                      <option value="">Selecione um Cliente</option>
                      {(data.clients || []).map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                  </select>
                  <button onClick={handleSave} disabled={loading} className="w-full bg-sky-500 text-white p-3 rounded-lg hover:bg-sky-600 transition font-bold disabled:bg-sky-300 flex items-center justify-center gap-2">
                    {loading && <div className="spinner"></div>}
                    Salvar Projeto
                  </button>
              </div>
          </Modal>
      );
  }

  function EditProjectModal({ isOpen, onClose, project }) {
    const { data, updateProject } = useData();
    const [editedProject, setEditedProject] = React.useState(null);
    const [error, setError] = React.useState('');
    const [loading, setLoading] = React.useState(false);

    React.useEffect(() => { if (project) { setEditedProject(project); } }, [project]);

    const handleSave = async () => {
        if (!editedProject.name.trim() || !editedProject.clientId || !editedProject.whatsappNumber.trim()) { setError('Nome, Cliente e Nº de WhatsApp são obrigatórios.'); return; }
        setLoading(true);
        setError('');
        try {
            await updateProject(editedProject.id, editedProject);
            onClose();
        } catch(e) {
            setError(e.message || "Erro ao atualizar projeto.");
        } finally {
            setLoading(false);
        }
    };
    
    const handleInputChange = (e) => {
        const { name, value } = e.target;
        setEditedProject(prev => ({ ...prev, [name]: name === 'clientId' ? parseInt(value, 10) : value }));
    };

    if (!editedProject) return null;

    return (
        <Modal isOpen={isOpen} onClose={onClose} title={`Editar Projeto: ${editedProject.name}`}>
            <div className="space-y-4">
                {error && <p className="text-red-500 text-sm">{error}</p>}
                <input type="text" name="name" placeholder="Nome do Projeto" value={editedProject.name} onChange={handleInputChange} className="w-full p-3 bg-slate-100 border border-slate-300 rounded-lg" />
                <input type="text" name="whatsappNumber" placeholder="Nº de WhatsApp do Bot" value={editedProject.whatsappNumber} onChange={handleInputChange} className="w-full p-3 bg-slate-100 border border-slate-300 rounded-lg" />
                <textarea name="description" placeholder="Descrição do Projeto" value={editedProject.description} onChange={handleInputChange} className="w-full p-3 bg-slate-100 border border-slate-300 rounded-lg min-h-[80px]"></textarea>
                <textarea name="objective" placeholder="Objetivo Principal" value={editedProject.objective} onChange={handleInputChange} className="w-full p-3 bg-slate-100 border border-slate-300 rounded-lg min-h-[80px]"></textarea>
                <select name="clientId" onChange={handleInputChange} value={editedProject.clientId} className="w-full p-3 bg-slate-100 border border-slate-300 rounded-lg">
                    <option value="">Selecione um Cliente</option>
                    {(data.clients || []).map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                </select>
                <button onClick={handleSave} disabled={loading} className="w-full bg-sky-500 text-white p-3 rounded-lg hover:bg-sky-600 transition font-bold disabled:bg-sky-300 flex items-center justify-center gap-2">
                  {loading && <div className="spinner"></div>}
                  Salvar Alterações
                </button>
            </div>
        </Modal>
    );
  }
  
  // ===================================
  //  PÁGINAS CORRIGIDAS
  // ===================================

  // --- UserManagement e Modais ---
  function AddUserModal({ isOpen, onClose }) {
    const { addUser } = useData();
    const [newUser, setNewUser] = React.useState({ name: '', email: '', password: '', role: 'tester' });
    const [error, setError] = React.useState('');
    const [loading, setLoading] = React.useState(false);
    const handleSave = async () => {
        if (!newUser.name.trim() || !newUser.email.trim() || !newUser.password.trim()) { setError('Todos os campos são obrigatórios.'); return; }
        setLoading(true);
        setError('');
        try {
            await addUser(newUser);
            setNewUser({ name: '', email: '', password: '', role: 'tester' });
            onClose();
        } catch(e) {
            setError(e.message || "Erro ao salvar usuário.");
        } finally {
            setLoading(false);
        }
    };
    const handleInputChange = (e) => {
        const { name, value } = e.target;
        setNewUser(prev => ({...prev, [name]: value}));
    };
    return (
        <Modal isOpen={isOpen} onClose={onClose} title="Adicionar Novo Usuário">
            <div className="space-y-4">
                {error && <p className="text-red-500 text-sm">{error}</p>}
                <input type="text" name="name" placeholder="Nome Completo" value={newUser.name} onChange={handleInputChange} className="w-full p-3 bg-slate-100 border border-slate-300 rounded-lg" />
                <input type="email" name="email" placeholder="Email" value={newUser.email} onChange={handleInputChange} className="w-full p-3 bg-slate-100 border border-slate-300 rounded-lg" />
                <input type="password" name="password" placeholder="Senha" value={newUser.password} onChange={handleInputChange} className="w-full p-3 bg-slate-100 border border-slate-300 rounded-lg" />
                <select name="role" value={newUser.role} onChange={handleInputChange} className="w-full p-3 bg-slate-100 border border-slate-300 rounded-lg">
                    <option value="tester">Tester</option>
                    <option value="client">Cliente</option>
                    <option value="admin">Admin</option>
                </select>
                <button onClick={handleSave} disabled={loading} className="w-full bg-sky-500 text-white p-3 rounded-lg hover:bg-sky-600 transition font-bold disabled:bg-sky-300 flex items-center justify-center gap-2">
                    {loading && <div className="spinner"></div>}
                    Salvar Usuário
                </button>
            </div>
        </Modal>
    );
  }

  function EditUserModal({ isOpen, onClose, user }) {
    const { updateUser } = useData();
    const [editedUser, setEditedUser] = React.useState(null);
    const [error, setError] = React.useState('');
    const [loading, setLoading] = React.useState(false);

    React.useEffect(() => {
        if (user) { setEditedUser({ ...user, password: '' }); }
    }, [user]);

    const handleSave = async () => {
        if (!editedUser.name.trim() || !editedUser.email.trim()) { setError('Nome e email são obrigatórios.'); return; }
        setLoading(true);
        setError('');
        try {
            const { password, ...rest } = editedUser;
            const updates = editedUser.password ? editedUser : rest;
            await updateUser(editedUser.id, updates);
            onClose();
        } catch(e) {
            setError(e.message || "Erro ao atualizar usuário.");
        } finally {
            setLoading(false);
        }
    };

    const handleInputChange = (e) => {
        const { name, value } = e.target;
        setEditedUser(prev => ({ ...prev, [name]: value }));
    };

    if (!editedUser) return null;

    return (
        <Modal isOpen={isOpen} onClose={onClose} title={`Editar Usuário: ${editedUser.name}`}>
            <div className="space-y-4">
                {error && <p className="text-red-500 text-sm">{error}</p>}
                <input type="text" name="name" placeholder="Nome Completo" value={editedUser.name} onChange={handleInputChange} className="w-full p-3 bg-slate-100 border border-slate-300 rounded-lg" />
                <input type="email" name="email" placeholder="Email" value={editedUser.email} onChange={handleInputChange} className="w-full p-3 bg-slate-100 border border-slate-300 rounded-lg" />
                <input type="password" name="password" placeholder="Nova Senha (deixe em branco para manter)" value={editedUser.password} onChange={handleInputChange} className="w-full p-3 bg-slate-100 border border-slate-300 rounded-lg" />
                <select name="role" value={editedUser.role} onChange={handleInputChange} className="w-full p-3 bg-slate-100 border border-slate-300 rounded-lg">
                    <option value="tester">Tester</option>
                    <option value="client">Cliente</option>
                    <option value="admin">Admin</option>
                </select>
                <button onClick={handleSave} disabled={loading} className="w-full bg-sky-500 text-white p-3 rounded-lg hover:bg-sky-600 transition font-bold disabled:bg-sky-300 flex items-center justify-center gap-2">
                    {loading && <div className="spinner"></div>}
                    Salvar Alterações
                </button>
            </div>
        </Modal>
    );
  }

  function UserManagement() { 
    const { user: currentUser } = useAuth();
    const { data, deleteUser } = useData();
    const [isAddModalOpen, setAddModalOpen] = React.useState(false);
    const [isEditModalOpen, setEditModalOpen] = React.useState(false);
    const [isDeleteModalOpen, setDeleteModalOpen] = React.useState(false);
    const [selectedUser, setSelectedUser] = React.useState(null);
    const [loading, setLoading] = React.useState(false);
    const [toast, setToast] = React.useState({message: '', type: 'error'});

    const handleEdit = (user) => {
        setSelectedUser(user);
        setEditModalOpen(true);
    };

    const handleDelete = (user) => {
        if (user.id === currentUser.id) {
            setToast({message: "Você não pode excluir sua própria conta.", type: 'error'});
            return;
        }
        setSelectedUser(user);
        setDeleteModalOpen(true);
    };

    const confirmDelete = async () => {
        setLoading(true);
        try {
            await deleteUser(selectedUser.id);
            setDeleteModalOpen(false);
            setSelectedUser(null);
        } catch(e) {
            alert(e.message || "Erro ao excluir usuário.");
        } finally {
            setLoading(false);
        }
    };
    
    const UserCard = ({ user }) => (
        <div className="bg-slate-50 rounded-lg p-4 flex justify-between items-center">
            <div>
                <p className="font-semibold">{user.name} {user.id === currentUser.id && <span className="text-xs text-blue-600">(Você)</span>}</p>
                <p className="text-sm text-slate-500">{user.email}</p>
            </div>
            <div className="flex items-center gap-4">
                <span className="px-2 py-1 text-xs font-semibold rounded-full bg-indigo-100 text-indigo-800 capitalize">{user.role}</span>
                <div className="flex gap-2">
                    <button onClick={() => handleEdit(user)} className="p-1 text-slate-500 hover:text-blue-600 transition-colors"><EditIcon className="w-5 h-5" /></button>
                    <button onClick={() => handleDelete(user)} disabled={user.id === currentUser.id} className="p-1 text-slate-500 hover:text-red-600 disabled:text-slate-300 disabled:cursor-not-allowed transition-colors"><TrashIcon className="w-5 h-5" /></button>
                </div>
            </div>
        </div>
    );

    return (
        <div className="space-y-6">
            <Toast message={toast.message} type={toast.type} onDismiss={() => setToast({ ...toast, message: ''})} />
            <button onClick={() => setAddModalOpen(true)} className="w-full sm:w-auto flex items-center justify-center gap-2 bg-sky-500 text-white px-4 py-3 rounded-lg font-semibold shadow hover:bg-sky-600 transition">
                <PlusIcon className="w-5 h-5" /> Adicionar Usuário
            </button>
            <div className="bg-white rounded-xl shadow-sm p-4 sm:p-6">
                <h3 className="font-bold text-lg mb-4">Usuários</h3>
                <div className="space-y-3">
                    {(data.users || []).map(u => <UserCard key={u.id} user={u} />)}
                </div>
            </div>
            <AddUserModal isOpen={isAddModalOpen} onClose={() => setAddModalOpen(false)} />
            <EditUserModal isOpen={isEditModalOpen} onClose={() => { setEditModalOpen(false); setSelectedUser(null); }} user={selectedUser} />
            <ConfirmationModal
                isOpen={isDeleteModalOpen}
                onClose={() => setDeleteModalOpen(false)}
                onConfirm={confirmDelete}
                title="Confirmar Exclusão"
                message={`Tem certeza que deseja excluir o usuário "${selectedUser?.name}"?`}
                loading={loading}
            />
        </div>
    );
  }

  // --- Reports e Modais ---
  function ReportDetailModal({ isOpen, onClose, report }) {
      const { data } = useData();
      if (!report) return null;

      const allTemplates = [...presetTests, ...(data.customTestTemplates || [])];
      const testCase = (data.testCases || []).find(tc => tc.id === report.testCaseId) || {};
      const preset = allTemplates.find(p => p.id === testCase.typeId) || {};
      const tester = (data.users || []).find(u => u.id === report.testerId) || {};
      const project = (data.projects || []).find(p => p.id === report.projectId) || {};
      const client = (data.clients || []).find(c => c.id == report.clientId) || {};
      
      const allFields = [...(preset?.formFields || []), ...(testCase.customFields || [])];

      const formattedDate = new Date(report.executionDate).toLocaleString('pt-BR', { dateStyle: 'long', timeStyle: 'short' });

      const generatePDF = () => {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          doc.setFontSize(18);
          doc.text(`Relatório de Teste: ${preset.name}`, 14, 22);
          doc.setFontSize(11);
          doc.setTextColor(100);
          doc.text(`ID do Relatório: ${report.id}`, 14, 32);
          doc.autoTable({
              startY: 40,
              head: [['Detalhe', 'Informação']],
              body: [
                  ['Cliente', client.name || 'N/A'], ['Projeto', project.name || 'N/A'],
                  ['Analista de testes', tester.name || 'N/A'], ['Data de Execução', formattedDate],
              ],
              theme: 'striped',
          });
          const finalY = doc.lastAutoTable.finalY || 10;
          doc.setFontSize(14);
          doc.text('Resultados da Execução', 14, finalY + 15);
          const tableBody = allFields.map(field => [field.label, (report.results || {})[field.name] || 'Não preenchido']);
          doc.autoTable({ startY: finalY + 20, head: [['Critério Avaliado', 'Resultado']], body: tableBody, theme: 'grid' });
          doc.save(`relatorio-${report.testCaseId}.pdf`);
      };

      return (
          <Modal isOpen={isOpen} onClose={onClose} title={`Detalhes do Relatório ${report.id}`} size="xl">
              <div className="space-y-4 text-sm">
                  <div className="bg-slate-50 p-3 rounded-lg space-y-1">
                      <p><span className="font-semibold">Teste:</span> {preset.name}</p>
                      <p><span className="font-semibold">Projeto:</span> {project.name}</p>
                      <p><span className="font-semibold">Cliente:</span> {client.name}</p>
                      <p><span className="font-semibold">Analista de testes:</span> {tester.name}</p>
                      <p><span className="font-semibold">Data:</span> {formattedDate}</p>
                  </div>
                  <h4 className="font-bold text-slate-800 pt-2 border-t">Resultados da Execução</h4>
                  <div className="space-y-2">
                      {allFields.map(field => (
                          <div key={field.name} className="bg-slate-50 p-2 rounded-md">
                              <p className="font-semibold text-slate-600">{field.label}</p>
                              <p className="text-slate-800 break-words">{(report.results || {})[field.name] || 'Não preenchido'}</p>
                          </div>
                      ))}
                  </div>
                  <div className="pt-4 border-t">
                      <button onClick={generatePDF} className="w-full bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 transition font-semibold">Exportar para PDF</button>
                  </div>
              </div>
          </Modal>
      );
  }

  function Reports() { 
    const { data } = useData();
    const [selectedReport, setSelectedReport] = React.useState(null);
    const ReportCard = ({ report }) => {
        const testCase = (data.testCases || []).find(tc => tc.id === report.testCaseId) || {};
        const allTemplates = [...presetTests, ...(data.customTestTemplates || [])];
        const preset = allTemplates.find(p => p.id === testCase.typeId) || {};
        const tester = (data.users || []).find(u => u.id === report.testerId) || {};
        const project = (data.projects || []).find(p => p.id === report.projectId) || {};
        const formattedDate = new Date(report.executionDate).toLocaleDateString('pt-BR');
        return (
            <div className="bg-white rounded-xl shadow-sm p-4 space-y-3">
                <div>
                    <h3 className="font-bold text-slate-800">{preset.name || 'Teste Desconhecido'}</h3>
                    <p className="text-sm text-slate-500">{project.name || 'Projeto Desconhecido'}</p>
                </div>
                <div className="text-xs text-slate-600 space-y-1">
                    <p><span className="font-semibold">Analista de testes:</span> {tester.name || 'N/A'}</p>
                    <p><span className="font-semibold">Data:</span> {formattedDate}</p>
                </div>
                <div className="pt-3 border-t">
                    <button onClick={() => setSelectedReport(report)} className="w-full bg-slate-100 text-slate-700 p-2 rounded-lg hover:bg-slate-200 transition font-semibold text-sm">Ver Detalhes</button>
                </div>
            </div>
        );
    };
    return (
        <div className="space-y-6">
            <h2 className="text-xl font-bold text-slate-800">Relatórios de Execução</h2>
            {(data.reports || []).length > 0 ? (
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    {(data.reports || []).map(r => <ReportCard key={r.id} report={r} />)}
                </div>
            ) : (
                <div className="text-center py-10 bg-white rounded-xl shadow-sm"><p className="text-slate-500">Nenhum relatório foi gerado ainda.</p></div>
            )}
            <ReportDetailModal isOpen={!!selectedReport} onClose={() => setSelectedReport(null)} report={selectedReport} />
        </div>
    );
  }
  
  // --- TestGuidelines ---
  function TestGuidelines() {
      const { data } = useData();
      const allTemplates = [...presetTests, ...(data.customTestTemplates || [])];

      const testsByCategory = allTemplates.reduce((acc, test) => {
          const category = test.category || 'Outros';
          if (!acc[category]) acc[category] = [];
          acc[category].push(test);
          return acc;
      }, {});

      const getGuidelineForField = (field) => {
        switch(field.type) {
          case 'tri-state': return 'Marque "Sim", "Não" ou "Não se Aplica" para o critério.';
          case 'textarea': return 'Forneça uma descrição detalhada ou observações relevantes.';
          case 'text': return 'Insira um texto curto e objetivo conforme o solicitado.';
          case 'select': return `Selecione uma das opções disponíveis: ${(field.options || []).join(', ')}.`;
          default: return 'Preencha o campo com a informação solicitada.';
        }
      }

      return (
        <div className="space-y-6">
          <h2 className="text-2xl font-bold text-slate-800">Orientações de Teste</h2>
          <p className="text-slate-600">Use este guia para entender os critérios de avaliação de cada tipo de teste.</p>
          <div className="space-y-8">
            {Object.keys(testsByCategory).sort().map(category => (
                <div key={category} className="bg-white p-6 rounded-xl shadow-sm">
                    <h3 className="text-xl font-bold text-sky-600 mb-4">{category}</h3>
                    <div className="space-y-6">
                    {testsByCategory[category].map(preset => (
                        <div key={preset.id} className="border-t pt-4 first:border-t-0 first:pt-0">
                            <h4 className="text-lg font-bold text-slate-800 mb-2">{preset.name}</h4>
                            <p className="text-sm text-slate-600 mb-4">{preset.description}</p>
                            <div>
                                <h5 className="font-semibold mb-2 text-slate-700">Itens a Avaliar:</h5>
                                <ul className="list-disc list-inside space-y-2 text-sm">
                                {preset.formFields.map(field => (
                                    <li key={field.name}>
                                        <span className="font-semibold">{field.label}:</span>
                                        <span className="text-slate-600 ml-1">{getGuidelineForField(field)}</span>
                                    </li>
                                ))}
                                </ul>
                            </div>
                        </div>
                    ))}
                    </div>
                </div>
            ))}
          </div>
        </div>
      );
  }

  // --- CustomTemplates e Modais ---
  function CreateCustomTemplateModal({ isOpen, onClose }) {
      const { addCustomTestTemplate } = useData();
      const [name, setName] = React.useState('');
      const [description, setDescription] = React.useState('');
      const [category, setCategory] = React.useState('Personalizado');
      const [fields, setFields] = React.useState([]);
      const [error, setError] = React.useState('');
      const [loading, setLoading] = React.useState(false);

      const addField = () => setFields([...fields, { id: Date.now(), name: '', label: '', type: 'text', options: [] }]);
      const handleFieldChange = (id, prop, value) => setFields(fields.map(f => f.id === id ? { ...f, [prop]: value } : f));
      
      const handleSave = async () => {
          if (!name.trim() || !description.trim() || fields.length === 0 || fields.some(f => !f.label.trim())) { setError("Nome, descrição e rótulo de todos os campos são obrigatórios."); return; }
          
          setLoading(true);
          const formFields = fields.map(({id, ...rest}) => {
              if(rest.type !== 'select') rest.options = [];
              rest.name = rest.label.toLowerCase().replace(/[^a-z0-9]+/g, '_') + `_${Math.random().toString(36).substr(2, 5)}`;
              return rest;
          });

          try {
            await addCustomTestTemplate({ name, description, category, formFields });
            setName(''); setDescription(''); setFields([]); setError(''); setCategory('Personalizado'); onClose();
          } catch (e) {
            setError(e.message || "Erro ao salvar modelo");
          } finally {
            setLoading(false);
          }
      };
      
      return (
          <Modal isOpen={isOpen} onClose={onClose} title="Criar Novo Modelo de Teste" size="2xl">
              <div className="space-y-4">
                  {error && <p className="text-red-500 text-sm">{error}</p>}
                  <input type="text" placeholder="Nome do Modelo" value={name} onChange={e => setName(e.target.value)} className="w-full p-3 bg-slate-100 border border-slate-300 rounded-lg"/>
                  <textarea placeholder="Descrição do Modelo" value={description} onChange={e => setDescription(e.target.value)} className="w-full p-3 bg-slate-100 border border-slate-300 rounded-lg"/>
                  <input type="text" placeholder="Categoria (ex: Financeiro)" value={category} onChange={e => setCategory(e.target.value)} className="w-full p-3 bg-slate-100 border border-slate-300 rounded-lg"/>
                  <div className="border-t pt-4">
                      <h4 className="font-semibold">Campos do Formulário</h4>
                      {fields.map(field => (
                          <div key={field.id} className="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2 p-3 border rounded-lg bg-slate-50">
                              <input type="text" placeholder="Nome do Campo (ex: 'Resposta foi clara?')" value={field.label} onChange={e => handleFieldChange(field.id, 'label', e.target.value)} className="w-full p-2 bg-white border border-slate-300 rounded-lg text-sm"/>
                              <select value={field.type} onChange={e => handleFieldChange(field.id, 'type', e.target.value)} className="w-full p-2 bg-white border border-slate-300 rounded-lg text-sm">
                                  <option value="text">Texto Curto</option>
                                  <option value="textarea">Texto Longo</option>
                                  <option value="tri-state">Sim/Não/N/A</option>
                                  <option value="select">Seleção</option>
                              </select>
                              {field.type === 'select' && <input type="text" placeholder="Opções separadas por vírgula" value={Array.isArray(field.options) ? field.options.join(',') : ''} onChange={e => handleFieldChange(field.id, 'options', e.target.value.split(',').map(s => s.trim()))} className="md:col-span-2 w-full p-2 bg-white border border-slate-300 rounded-lg text-sm"/>}
                          </div>
                      ))}
                      <button onClick={addField} className="mt-2 text-sm text-sky-600 hover:text-sky-800">+ Adicionar Campo</button>
                  </div>
                  <button onClick={handleSave} disabled={loading} className="w-full bg-sky-500 text-white p-3 rounded-lg hover:bg-sky-600 transition font-bold mt-4 disabled:bg-sky-300 flex items-center justify-center gap-2">
                    {loading && <div className="spinner"></div>}
                    Salvar Modelo
                  </button>
              </div>
          </Modal>
      );
  }
  
  function EditCustomTemplateModal({ isOpen, onClose, template }) {
    const { updateCustomTestTemplate } = useData();
    const [name, setName] = React.useState('');
    const [description, setDescription] = React.useState('');
    const [category, setCategory] = React.useState('');
    const [fields, setFields] = React.useState([]);
    const [error, setError] = React.useState('');
    const [loading, setLoading] = React.useState(false);

    React.useEffect(() => {
        if (template) {
            setName(template.name);
            setDescription(template.description);
            setCategory(template.category || 'Personalizado');
            setFields(template.formFields.map(f => ({ ...f, id: f.name || `field_${Math.random()}` })));
        }
    }, [template]);
    
    const addField = () => setFields([...fields, { id: `new_${Date.now()}`, name: '', label: '', type: 'text', options: [] }]);
    const handleFieldChange = (id, prop, value) => setFields(fields.map(f => f.id === id ? { ...f, [prop]: value } : f));
    
    const handleSave = async () => {
        if (!name.trim() || !description.trim() || fields.some(f => !f.label.trim())) { setError("Nome, descrição e o rótulo de todos os campos são obrigatórios."); return; }
        setLoading(true);
        const formFields = fields.map(({id, ...rest}) => {
            if(rest.type !== 'select') rest.options = [];
            rest.name = rest.name || rest.label.toLowerCase().replace(/[^a-z0-9]+/g, '_') + `_${Math.random().toString(36).substr(2, 5)}`;
            return rest;
        });

        try {
            await updateCustomTestTemplate(template.id, { name, description, category, formFields });
            onClose();
        } catch(e) {
            setError(e.message || "Erro ao atualizar o modelo");
        } finally {
            setLoading(false);
        }
    };

    if (!template) return null;

    return (
        <Modal isOpen={isOpen} onClose={onClose} title={`Editar Modelo: ${template.name}`} size="2xl">
            <div className="space-y-4">
                {error && <p className="text-red-500 text-sm">{error}</p>}
                <input type="text" placeholder="Nome do Modelo" value={name} onChange={e => setName(e.target.value)} className="w-full p-3 bg-slate-100 border border-slate-300 rounded-lg"/>
                <textarea placeholder="Descrição do Modelo" value={description} onChange={e => setDescription(e.target.value)} className="w-full p-3 bg-slate-100 border border-slate-300 rounded-lg"/>
                <input type="text" placeholder="Categoria" value={category} onChange={e => setCategory(e.target.value)} className="w-full p-3 bg-slate-100 border border-slate-300 rounded-lg"/>
                <div className="border-t pt-4">
                    <h4 className="font-semibold">Campos do Formulário</h4>
                    {fields.map(field => (
                        <div key={field.id} className="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2 p-3 border rounded-lg bg-slate-50">
                            <input type="text" placeholder="Nome do Campo" value={field.label} onChange={e => handleFieldChange(field.id, 'label', e.target.value)} className="w-full p-2 bg-white border border-slate-300 rounded-lg text-sm"/>
                            <select value={field.type} onChange={e => handleFieldChange(field.id, 'type', e.target.value)} className="w-full p-2 bg-white border border-slate-300 rounded-lg text-sm">
                                <option value="text">Texto Curto</option>
                                <option value="textarea">Texto Longo</option>
                                <option value="tri-state">Sim/Não/N/A</option>
                                <option value="select">Seleção</option>
                            </select>
                            {field.type === 'select' && <input type="text" placeholder="Opções separadas por vírgula" value={Array.isArray(field.options) ? field.options.join(',') : ''} onChange={e => handleFieldChange(field.id, 'options', e.target.value.split(',').map(s => s.trim()))} className="md:col-span-2 w-full p-2 bg-white border border-slate-300 rounded-lg text-sm"/>}
                        </div>
                    ))}
                    <button onClick={addField} className="mt-2 text-sm text-sky-600 hover:text-sky-800">+ Adicionar Campo</button>
                </div>
                <button onClick={handleSave} disabled={loading} className="w-full bg-sky-500 text-white p-3 rounded-lg hover:bg-sky-600 transition font-bold mt-4 disabled:bg-sky-300 flex items-center justify-center gap-2">
                  {loading && <div className="spinner"></div>}
                  Salvar Alterações
                </button>
            </div>
        </Modal>
    );
  }

  function CustomTemplates() { 
    const { data, deleteCustomTestTemplate } = useData();
    const [isAddModalOpen, setAddModalOpen] = React.useState(false);
    const [isEditModalOpen, setEditModalOpen] = React.useState(false);
    const [isDeleteModalOpen, setDeleteModalOpen] = React.useState(false);
    const [selectedTemplate, setSelectedTemplate] = React.useState(null);
    const [loading, setLoading] = React.useState(false);

    const handleEdit = (template) => { setSelectedTemplate(template); setEditModalOpen(true); };
    const handleDelete = (template) => { setSelectedTemplate(template); setDeleteModalOpen(true); };
    const confirmDelete = async () => { 
        setLoading(true);
        try {
            await deleteCustomTestTemplate(selectedTemplate.id); 
            setDeleteModalOpen(false); 
            setSelectedTemplate(null);
        } catch(e) {
            alert(e.message || "Erro ao excluir modelo");
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="space-y-6">
        <button onClick={() => setAddModalOpen(true)} className="w-full sm:w-auto flex items-center justify-center gap-2 bg-sky-500 text-white px-4 py-3 rounded-lg font-semibold shadow hover:bg-sky-600 transition">
            <PlusIcon className="w-5 h-5" /> Criar Novo Modelo
        </button>
        <div className="bg-white rounded-xl shadow-sm p-4 sm:p-6">
            <h3 className="font-bold text-lg mb-4">Modelos Personalizados</h3>
            <div className="space-y-3">
                {(data.customTestTemplates || []).length > 0 ? 
                    (data.customTestTemplates || []).map(t => (
                        <div key={t.id} className="bg-slate-50 p-3 rounded-lg flex justify-between items-center">
                            <div>
                                <span className="font-semibold">{t.name}</span>
                                <span className="text-xs ml-2 bg-indigo-100 text-indigo-800 px-2 py-0.5 rounded-full">{t.category}</span>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => handleEdit(t)} className="p-1 text-slate-500 hover:text-blue-600 transition-colors"><EditIcon className="w-5 h-5" /></button>
                                <button onClick={() => handleDelete(t)} className="p-1 text-slate-500 hover:text-red-600 transition-colors"><TrashIcon className="w-5 h-5" /></button>
                            </div>
                        </div>
                    )) : <p className="text-slate-500 text-center py-4">Nenhum modelo personalizado foi criado.</p>
                }
            </div>
        </div>
        <CreateCustomTemplateModal isOpen={isAddModalOpen} onClose={() => setAddModalOpen(false)} />
        <EditCustomTemplateModal isOpen={isEditModalOpen} onClose={() => { setEditModalOpen(false); setSelectedTemplate(null); }} template={selectedTemplate} />
        <ConfirmationModal isOpen={isDeleteModalOpen} onClose={() => setDeleteModalOpen(false)} onConfirm={confirmDelete} title="Confirmar Exclusão" message={`Tem certeza que deseja excluir o modelo "${selectedTemplate?.name}"?`} loading={loading} />
        </div>
    );
  }
  
  // --- Settings e Modais ---
  function WebhookModal({ isOpen, onClose, onSave, webhook }) {
      const [url, setUrl] = React.useState('');
      const [selectedEvents, setSelectedEvents] = React.useState([]);
      const [error, setError] = React.useState('');
      const [loading, setLoading] = React.useState(false);

      React.useEffect(() => {
          if (webhook) {
              setUrl(webhook.url);
              setSelectedEvents(webhook.events);
          } else {
              setUrl('');
              setSelectedEvents([]);
          }
      }, [webhook]);
      
      const handleEventToggle = (eventId) => {
          setSelectedEvents(prev => prev.includes(eventId) ? prev.filter(id => id !== eventId) : [...prev, eventId]);
      };
      
      const handleSave = async () => {
          try {
              new URL(url); // Basic URL validation
          } catch (_) {
              setError("A URL fornecida é inválida.");
              return;
          }
          if (selectedEvents.length === 0) {
              setError("Selecione pelo menos um evento para assinar.");
              return;
          }
          setLoading(true);
          try {
            await onSave({ url, events: selectedEvents });
            onClose();
          } catch (e) {
            setError(e.message || "Erro ao salvar webhook.");
          } finally {
            setLoading(false);
          }
      };
      
      return (
          <Modal isOpen={isOpen} onClose={onClose} title={webhook ? "Editar Webhook" : "Adicionar Novo Webhook"} size="xl">
              <div className="space-y-4">
                  {error && <p className="text-red-500 text-sm mb-4">{error}</p>}
                  <div>
                      <label className="text-sm font-bold text-slate-600 mb-1 block">URL do Webhook</label>
                      <input type="url" placeholder="https://seu-servico.com/webhook" value={url} onChange={e => setUrl(e.target.value)} className="w-full p-3 bg-slate-100 border border-slate-300 rounded-lg" />
                  </div>
                  <div>
                      <label className="text-sm font-bold text-slate-600 mb-2 block">Eventos para Assinar</label>
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                          {webhookEvents.map(event => (
                              <label key={event.id} className="flex items-center gap-3 p-3 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100 transition">
                                  <input type="checkbox" checked={selectedEvents.includes(event.id)} onChange={() => handleEventToggle(event.id)} className="h-5 w-5 rounded border-slate-300 text-sky-600 focus:ring-sky-500" />
                                  <span className="font-semibold text-slate-700">{event.label}</span>
                              </label>
                          ))}
                      </div>
                  </div>
                  <div className="pt-4 border-t">
                      <button onClick={handleSave} disabled={loading} className="w-full bg-sky-500 text-white p-3 rounded-lg hover:bg-sky-600 transition font-bold disabled:bg-sky-300 flex items-center justify-center gap-2">
                          {loading && <div className="spinner"></div>}
                          Salvar Webhook
                      </button>
                  </div>
              </div>
          </Modal>
      );
  }

  function Settings() {
    const { data, addWebhook, updateWebhook, deleteWebhook } = useData();
    const [isModalOpen, setIsModalOpen] = React.useState(false);
    const [isDeleteModalOpen, setDeleteModalOpen] = React.useState(false);
    const [selectedWebhook, setSelectedWebhook] = React.useState(null);
    const [loading, setLoading] = React.useState(false);

    const handleOpenModal = (webhook = null) => {
        setSelectedWebhook(webhook);
        setIsModalOpen(true);
    };

    const handleSaveWebhook = async (webhookData) => {
        if (selectedWebhook) {
            await updateWebhook(selectedWebhook.id, webhookData);
        } else {
            await addWebhook(webhookData);
        }
    };

    const handleDelete = (webhook) => {
        setSelectedWebhook(webhook);
        setDeleteModalOpen(true);
    };

    const confirmDelete = async () => {
        setLoading(true);
        try {
            await deleteWebhook(selectedWebhook.id);
            setDeleteModalOpen(false);
            setSelectedWebhook(null);
        } catch(e) {
            alert(e.message || "Erro ao excluir webhook.");
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="space-y-6">
            <div className="bg-white rounded-xl shadow-sm p-4 sm:p-6">
                <h3 className="font-bold text-lg mb-4">Webhooks</h3>
                <p className="text-sm text-slate-600 mb-4">Configure webhooks para receber notificações em tempo real sobre eventos importantes no sistema.</p>
                <button onClick={() => handleOpenModal()} className="w-full sm:w-auto flex items-center justify-center gap-2 bg-sky-500 text-white px-4 py-3 rounded-lg font-semibold shadow hover:bg-sky-600 transition">
                    <PlusIcon className="w-5 h-5" /> Adicionar Webhook
                </button>
                <div className="mt-6 space-y-3">
                    {(data.webhooks || []).length > 0 ? (
                        (data.webhooks || []).map(wh => (
                            <div key={wh.id} className="bg-slate-50 p-4 rounded-lg">
                                <div className="flex justify-between items-center mb-3">
                                    <p className="font-mono text-sm text-slate-700 break-all">{wh.url}</p>
                                    <div className="flex gap-2 flex-shrink-0 ml-4">
                                        <button onClick={() => handleOpenModal(wh)} className="p-1 text-slate-500 hover:text-blue-600 transition-colors"><EditIcon className="w-5 h-5" /></button>
                                        <button onClick={() => handleDelete(wh)} className="p-1 text-slate-500 hover:text-red-600 transition-colors"><TrashIcon className="w-5 h-5" /></button>
                                    </div>
                                </div>
                                <div className="flex flex-wrap gap-2">
                                    {wh.events.map(eventId => {
                                        const event = webhookEvents.find(e => e.id === eventId);
                                        return <span key={eventId} className="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">{event?.label || eventId}</span>
                                    })}
                                </div>
                            </div>
                        ))
                    ) : (
                        <p className="text-slate-500 text-center py-4">Nenhum webhook configurado.</p>
                    )}
                </div>
            </div>
            <WebhookModal 
                isOpen={isModalOpen} 
                onClose={() => setIsModalOpen(false)}
                onSave={handleSaveWebhook}
                webhook={selectedWebhook}
            />
            <ConfirmationModal
                isOpen={isDeleteModalOpen}
                onClose={() => setDeleteModalOpen(false)}
                onConfirm={confirmDelete}
                title="Confirmar Exclusão"
                message={`Tem certeza que deseja excluir o webhook para a URL "${selectedWebhook?.url}"?`}
                loading={loading}
            />
        </div>
    );
  }

  // --- TestManagement e Modais ---
  function TestExecutionForm({ testCase, onExecute, onCancel, onPause }) {
      const { data } = useData();
      const allTemplates = [...presetTests, ...(data.customTestTemplates || [])];
      const preset = allTemplates.find(p => p.id === testCase.typeId);
      const [formData, setFormData] = React.useState(testCase.pausedState || {});
      const handleInputChange = (name, value) => { setFormData(prev => ({ ...prev, [name]: value })); };
      const handleSubmit = () => { onExecute(testCase.id, formData); };
      const handlePause = () => { onPause(testCase.id, formData); };
      
      const allFields = [...(preset?.formFields || []), ...(testCase.customFields || [])];

      if (!preset) { return <div className="text-red-500 p-4">Erro: Tipo de teste não encontrado.</div>; }
      
      return (
        <div className="p-4 space-y-4">
          <h4 className="font-bold text-slate-700">Executando: {preset.name}</h4>
          {allFields.map(field => (
            <div key={field.name}>
              <label className="block text-sm font-semibold text-slate-600 mb-1">{field.label}</label>
              {field.type === 'textarea' && ( <textarea name={field.name} placeholder={field.placeholder || ''} value={formData[field.name] || ''} onChange={e => handleInputChange(e.target.name, e.target.value)} className="w-full p-2 bg-slate-100 border border-slate-300 rounded-lg text-sm"></textarea> )}
              {field.type === 'text' && ( <input type="text" name={field.name} placeholder={field.placeholder || ''} value={formData[field.name] || ''} onChange={e => handleInputChange(e.target.name, e.target.value)} className="w-full p-2 bg-slate-100 border border-slate-300 rounded-lg text-sm" /> )}
              {field.type === 'tri-state' && (
                <select name={field.name} value={formData[field.name] || ''} onChange={e => handleInputChange(e.target.name, e.target.value)} className="w-full p-2 bg-slate-100 border border-slate-300 rounded-lg text-sm">
                  <option value="">Selecione...</option>
                  <option value="Sim">Sim</option>
                  <option value="Não">Não</option>
                  <option value="N/A">Não se aplica</option>
                </select>
              )}
              {field.type === 'select' && (
                <select name={field.name} value={formData[field.name] || ''} onChange={e => handleInputChange(e.target.name, e.target.value)} className="w-full p-2 bg-slate-100 border border-slate-300 rounded-lg text-sm">
                  <option value="">Selecione...</option>
                  {(field.options || []).map(opt => <option key={opt} value={opt}>{opt}</option>)}
                </select>
              )}
            </div>
          ))}
          <div className="flex gap-2 pt-4">
             <button onClick={onCancel} className="w-full bg-slate-200 text-slate-700 p-2 rounded-lg hover:bg-slate-300 transition font-semibold text-sm">Cancelar</button>
             <button onClick={handlePause} className="w-full bg-yellow-500 text-white p-2 rounded-lg hover:bg-yellow-600 transition font-semibold text-sm">Pausar</button>
             <button onClick={handleSubmit} className="w-full bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 transition font-semibold text-sm">Concluir</button>
          </div>
        </div>
      );
  }

  function CreateTestModal({ isOpen, onClose }) {
      const { data, addTest } = useData();
      const [selectedClient, setSelectedClient] = React.useState('');
      const [filteredProjects, setFilteredProjects] = React.useState([]);
      const [newTest, setNewTest] = React.useState({ projectId: "", typeId: "", assignedTo: "", customFields: [] });
      const [error, setError] = React.useState("");
      const [customFields, setCustomFields] = React.useState([]);
      const [loading, setLoading] = React.useState(false);
      
      const allTemplates = [...presetTests, ...(data.customTestTemplates || [])];
      
      const testsByCategory = allTemplates.reduce((acc, test) => {
          const category = test.category || 'Outros';
          if (!acc[category]) acc[category] = [];
          acc[category].push(test);
          return acc;
      }, {});

      const handleAddCustomField = () => {
        setCustomFields([...customFields, { id: Date.now(), name: `custom_${Date.now()}`, label: '', type: 'text' }]);
      };
      const handleCustomFieldChange = (id, fieldName, value) => {
        setCustomFields(customFields.map(f => f.id === id ? { ...f, [fieldName]: value } : f));
      };
      
      React.useEffect(() => {
          if(selectedClient) {
              setFilteredProjects((data.projects || []).filter(p => p.clientId == selectedClient));
              setNewTest(nt => ({...nt, projectId: ''}));
          } else { setFilteredProjects([]); }
      }, [selectedClient, data.projects]);
      
      const handleAddTest = async () => {
          if (!newTest.projectId || !newTest.typeId || !newTest.assignedTo) { setError("Preencha todos os campos obrigatórios."); return; }
          setLoading(true);
          const finalCustomFields = customFields.filter(f => f.label.trim() !== '');
          try {
            await addTest({...newTest, customFields: finalCustomFields});
            setNewTest({ projectId: "", typeId: "", assignedTo: "", customFields: [] });
            setCustomFields([]);
            setError("");
            onClose(); 
          } catch(e) {
            setError(e.message || "Erro ao criar teste");
          } finally {
            setLoading(false);
          }
      };
      
      const handleInputChange = (e) => {
        const { name, value } = e.target;
        const finalValue = (name === 'assignedTo' || name === 'projectId') && value ? parseInt(value, 10) : value;
        setNewTest(prev => ({...prev, [name]: finalValue}));
      };

      return (
          <Modal isOpen={isOpen} onClose={onClose} title="Criar Novo Caso de Teste">
              <div className="space-y-4">
                  {error && <p className="text-red-500 text-sm">{error}</p>}
                  <select onChange={(e) => setSelectedClient(e.target.value)} value={selectedClient} className="w-full p-3 bg-slate-100 border border-slate-300 rounded-lg">
                      <option value="">1. Selecione um Cliente</option>
                      {(data.clients || []).map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                  </select>
                  <select name="projectId" onChange={handleInputChange} value={newTest.projectId} disabled={!selectedClient} className="w-full p-3 bg-slate-100 border border-slate-300 rounded-lg disabled:bg-slate-200">
                      <option value="">2. Selecione um Projeto</option>
                      {filteredProjects.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                  </select>
                  <select name="typeId" onChange={handleInputChange} value={newTest.typeId} className="w-full p-3 bg-slate-100 border border-slate-300 rounded-lg">
                      <option value="">3. Selecione o Tipo de Teste</option>
                      {Object.keys(testsByCategory).sort().map(category => (
                          <optgroup key={category} label={category}>
                              {testsByCategory[category].map(pt => <option key={pt.id} value={pt.id}>{pt.name}</option>)}
                          </optgroup>
                      ))}
                  </select>
                  <select name="assignedTo" onChange={handleInputChange} value={newTest.assignedTo} className="w-full p-3 bg-slate-100 border border-slate-300 rounded-lg">
                      <option value="">4. Atribuir a um Analista de testes</option>
                      {(data.users || []).filter(u => u.role === 'tester').map(u => <option key={u.id} value={u.id}>{u.name}</option>)}
                  </select>
                  
                  <div className="border-t pt-4">
                      <h4 className="font-semibold text-slate-700">Itens Personalizados (Opcional)</h4>
                      {customFields.map(field => (
                          <div key={field.id} className="flex items-center gap-2 mt-2">
                              <input type="text" placeholder="Nome do Item" value={field.label} onChange={e => handleCustomFieldChange(field.id, 'label', e.target.value)} className="flex-1 p-2 bg-white border border-slate-300 rounded-lg text-sm" />
                              <select value={field.type} onChange={e => handleCustomFieldChange(field.id, 'type', e.target.value)} className="p-2 bg-white border border-slate-300 rounded-lg text-sm">
                                  <option value="text">Texto</option>
                                  <option value="tri-state">Sim/Não/N/A</option>
                              </select>
                          </div>
                      ))}
                      <button onClick={handleAddCustomField} className="mt-2 text-sm text-sky-600 hover:text-sky-800">+ Adicionar Item</button>
                  </div>
                  
                  <button onClick={handleAddTest} disabled={loading} className="w-full bg-sky-500 text-white p-3 rounded-lg hover:bg-sky-600 transition font-bold mt-4 disabled:bg-sky-300 flex items-center justify-center gap-2">
                    {loading && <div className="spinner"></div>}
                    Adicionar Teste
                  </button>
              </div>
          </Modal>
      );
  }

  function TestManagement() {
      const { user } = useAuth();
      const { data, executeTest, updateTestCase, deleteTest } = useData();
      const [toast, setToast] = React.useState({ message: '', type: 'success' });
      const [isCreateModalOpen, setCreateModalOpen] = React.useState(false);
      const [executingTestId, setExecutingTestId] = React.useState(null);
      const [isDeleteModalOpen, setDeleteModalOpen] = React.useState(false);
      const [selectedTest, setSelectedTest] = React.useState(null);
      const [loading, setLoading] = React.useState(false);

      const handleExecuteTest = async (id, resultData) => {
          setLoading(true);
          try {
            await executeTest(id, resultData, user);
            setToast({ message: "Teste executado com sucesso! Relatório gerado.", type: 'success' });
            setExecutingTestId(null);
          } catch(e) {
            alert(e.message || "Erro ao executar teste.");
          } finally {
            setLoading(false);
          }
      };
      
      const handlePauseTest = async (id, formData) => {
          await updateTestCase(id, { status: 'paused', pausedState: formData });
          setToast({ message: "Teste pausado com sucesso.", type: 'success' });
          setExecutingTestId(null);
      };

      const handleResumeTest = async (tc) => {
          await updateTestCase(tc.id, { status: 'pending', pausedState: tc.pausedState });
          setExecutingTestId(tc.id);
      };

      const handleDelete = (test) => {
        setSelectedTest(test);
        setDeleteModalOpen(true);
      };

      const confirmDelete = async () => {
          setLoading(true);
          try {
            await deleteTest(selectedTest.id);
            setDeleteModalOpen(false);
            setSelectedTest(null);
          } catch(e) {
            alert(e.message || "Erro ao excluir teste.");
          } finally {
            setLoading(false);
          }
      };

      const filteredTestCases = (data.testCases || []).filter(tc => user.role === 'admin' || tc.assignedTo === user.id);
      const statusStyles = { pending: "bg-yellow-100 text-yellow-800", completed: "bg-green-100 text-green-800", paused: "bg-orange-100 text-orange-800" };
      
      const TestCaseCard = ({ tc }) => {
          const allTemplates = [...presetTests, ...(data.customTestTemplates || [])];
          const preset = allTemplates.find(p => p.id === tc.typeId) || {};
          const project = (data.projects || []).find(p => p.id === tc.projectId) || {};
          const client = (data.clients || []).find(c => c.id === project.clientId) || {};
          return (
              <div className="bg-white rounded-xl shadow-sm overflow-hidden">
                  <div className="p-4">
                      <div className="flex justify-between items-start">
                          <div>
                              <p className="text-xs font-semibold text-sky-600">{preset.category || 'Personalizado'}</p>
                              <h3 className="font-bold text-slate-800">{preset.name}</h3>
                              <p className="text-sm text-slate-500">{project.name} - {client.name}</p>
                          </div>
                          <div className="flex items-center gap-2">
                              <span className={`px-2.5 py-0.5 text-xs font-semibold rounded-full ${statusStyles[tc.status]}`}>{tc.status}</span>
                              {user.role === 'admin' && (
                                  <button onClick={() => handleDelete(tc)} className="p-1 text-slate-400 hover:text-red-600 transition-colors"><TrashIcon className="w-4 h-4" /></button>
                              )}
                          </div>
                      </div>
                      <p className="text-sm text-slate-600 mt-2">{preset.description}</p>
                      {user.role === "tester" && tc.status === "pending" && executingTestId !== tc.id && (
                          <div className="pt-4 mt-4 border-t border-slate-200">
                              <button onClick={() => setExecutingTestId(tc.id)} className="w-full bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 transition font-semibold text-sm">Iniciar Execução</button>
                          </div>
                      )}
                      {user.role === "tester" && tc.status === "paused" && executingTestId !== tc.id && (
                          <div className="pt-4 mt-4 border-t border-slate-200">
                              <button onClick={() => handleResumeTest(tc)} className="w-full bg-orange-500 text-white p-2 rounded-lg hover:bg-orange-600 transition font-semibold text-sm">Retomar Execução</button>
                          </div>
                      )}
                  </div>
                  {executingTestId === tc.id && (
                      <div className="bg-slate-50 border-t border-slate-200">
                        <TestExecutionForm testCase={tc} onExecute={handleExecuteTest} onCancel={() => setExecutingTestId(null)} onPause={handlePauseTest} />
                      </div>
                  )}
              </div>
          );
      };
      
      return (
          <div className="space-y-6">
              {user.role === 'admin' && (
                  <button onClick={() => setCreateModalOpen(true)} className="w-full sm:w-auto flex items-center justify-center gap-2 bg-sky-500 text-white px-4 py-3 rounded-lg font-semibold shadow hover:bg-sky-600 transition">
                      <PlusIcon className="w-5 h-5" /> Criar Novo Teste
                  </button>
              )}
              <div className="space-y-4">
                {filteredTestCases.length > 0 ? filteredTestCases.map(tc => <TestCaseCard key={tc.id} tc={tc} />) : <div className="text-center py-10 bg-white rounded-xl shadow-sm"><p className="text-slate-500">Nenhum teste atribuído.</p></div>}
              </div>
              <Toast message={toast.message} type={toast.type} onDismiss={() => setToast({ ...toast, message: ''})} />
              <CreateTestModal isOpen={isCreateModalOpen} onClose={() => setCreateModalOpen(false)} />
              <ConfirmationModal
                  isOpen={isDeleteModalOpen}
                  onClose={() => setDeleteModalOpen(false)}
                  onConfirm={confirmDelete}
                  title="Confirmar Exclusão"
                  message={`Tem certeza que deseja excluir o caso de teste "${selectedTest?.id}"?`}
                  loading={loading}
              />
          </div>
      );
  }

  // --- COMPONENTE PRINCIPAL ---
  function AppContent() {
    const { user } = useAuth();
    const { page } = useNavigation();

    if (!user) { return <Login />; }
    
    const pageMap = {
        'dashboard': <Dashboard />,
        'client-management': <ClientManagement />,
        'project-management': <ProjectManagement />,
        'test-management': <TestManagement />,
        'user-management': <UserManagement />,
        'reports': <Reports />,
        'test-guidelines': <TestGuidelines />,
        'custom-templates': <CustomTemplates />,
        'settings': <Settings />
    };
    
    const adminOnlyPages = ['client-management', 'project-management', 'user-management', 'custom-templates', 'settings'];
    
    const PageComponent = () => {
        if(adminOnlyPages.includes(page) && user.role !== 'admin') {
            return <Dashboard />; // Redireciona para o dashboard se não for admin
        }
        return pageMap[page] || <Dashboard />;
    };

    return (<AppLayout><PageComponent /></AppLayout>);
  }

  function App() {
    return (
      <DataProvider>
          <AuthProvider>
              <NavigationProvider>
                  <AppContent />
              </NavigationProvider>
          </AuthProvider>
      </DataProvider>
    );
  }
  
  // --- RENDERIZAÇÃO ---
  try {
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  } catch (err) {
    console.error("Erro ao montar a aplicação React:", err);
    document.getElementById('root').innerHTML = `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg max-w-md mx-auto mt-10" role="alert"><h2 class="font-bold">Erro Interno da Aplicação</h2><p>Ocorreu um problema ao renderizar o componente principal.</p><pre class="mt-2 text-xs">${err.message}</pre></div>`;
  }
</script>

</body>
</html>
